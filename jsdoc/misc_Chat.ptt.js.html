<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: misc/Chat.ptt.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: misc/Chat.ptt.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Creates a chat element to chat with other clients.
 * @constructor
 */
function Chat() {
	var self = this;
	this.$history = $('&lt;div class="history" />');
	this.$input = $('&lt;input type="text" id="chat" autocomplete="off" />');
	this.$form = $('&lt;form />').on("submit", function() {
		self.submit();
		return false;
	}).append(this.$input);
	this.$chat = $('&lt;div class="chat mini" />').append(this.$history, this.$form);
	this.$history.html("&lt;i>Empty chat&lt;/i>");
	$("body").append(this.$chat);
	
	this.$chat.click(function() {
		if ($(this).is(".mini")) {
			$(this).removeClass("mini");
			self.$input.focus();
		} else $(this).addClass("mini");
	});
	this.$history.click(function() {
		self.$input.focus();
		event.stopPropagation();
	});
	this.$form.click(function(event) { event.stopPropagation() });
	
	this.history = {};
	
	this.initServer();
	
	if (Cookies.get("name") !== undefined) {
		var name = this.validateName(Cookies.get('name'));
		if (name) {
			main.server.name = name;
			Cookies.set("name", name, { expires: 7 });
			main.server.broadcast(BroadcastType.NAME, name);
		}
	}
};

/**
 * Initializes some server settings and functions to receive chat messages
 * and names.
 */
Chat.prototype.initServer = function() {
	var self = this;
	BroadcastType.NAME = BroadcastType.index++;
	BroadcastType.CHAT = BroadcastType.index++;
	main.server.names = {};
	main.server.broadcasts[BroadcastType.NAME] = function(resp) {
		var name = self.validateName(resp.data);
		if (name) {
			for (var x in main.server.names) {
				if (main.server.names[x] == name) return false;
			}
			main.server.names[resp.userId] = name;
			self.refresh();
			Cookies.set("name", name, { expires: 7 });
		}
	};
	main.server.broadcasts[BroadcastType.CHAT] = function(resp) {
		self.history[resp.data.date + "_" + resp.userId] = {
			u: resp.userId,
			t: resp.data.message
		};
		self.refresh.apply(self);
	};
	main.server.connects.push(function() {
		if (main.server.name) main.server.broadcast(BroadcastType.NAME, main.server.name);
	});
};

/**
 * Submits and broadcasts the own input. Clears the input.
 */
Chat.prototype.submit = function() {
	var val = this.$input.val(),
		date = main.server.getTime();
	
	if (val.length) {
		if (val.substr(0, 6) == "/name ") {
			main.server.name = this.validateName(val.substr(6));
			if (main.server.name) main.server.broadcast(BroadcastType.NAME, main.server.name);
		} else {
			this.history[date + "_0"] = { u: 0, t: val };
			this.broadcast(date, val);
			this.refresh();
		}
		this.$input.val("");
	}
};

/**
 * Initializes some mouse events to hide the chat while drawing.
 */
Chat.prototype.init = function() {
	var self = this;
	main.board.$board.on("mousedown.chat", function(event) {
		self.hide.apply(self);
	}).on("mouseenter.chat", function(event) {
		if (event.buttons == 1) self.hide.apply(self);
	}).on("mouseup.chat mouseleave.chat", function(event) {
		self.show.apply(self);
	});
};

/**
 * Shows the chat. Adds an opacity transition if the hide time is over 300ms.
 */
Chat.prototype.show = function() {
	if (this.hideTime) {
		if (main.server.getTime() - this.hideTime > 300) {
			this.$chat.css("opacity", 0).show().stop().animate({
				opacity: 1
			}, 1000);
		} else {
			this.$chat.show();
		}
		this.hideTime = 0;
	}
};

/**
 * Hides the chat and remembers, when the chat was hidden.
 */
Chat.prototype.hide = function() {
	this.hideTime = main.server.getTime();
	this.$chat.hide();
};

/**
 * Validates the user name. Checks it before sending and after receiving.
 */
Chat.prototype.validateName = function(name) {
	name = name
		.replace(/^\s+/, "").replace(/\s+$/, "") // remove space at start and end
		.replace(/\s/g, "-") // replace spaces with dash
		.replace(/[^a-zA-Z0-9_-]/g, "") // only this chars are allowed
		.substr(0, 20); // max 20 chars
	if (name == "Me") return false;
	return name;
};

/**
 * Broadcasts a message with the date.
 */
Chat.prototype.broadcast = function(date, msg) {
	main.server.broadcast(BroadcastType.CHAT, {
		date: date,
		message: msg
	});
};

/**
 * Refreshes the history and displays all messages.
 */
Chat.prototype.refresh = function() {
	var keys = Object.keys(this.history), klen = keys.length, limit = 100;
	if (klen > limit) {
		for (var i = 0; i &lt; klen - limit; i++) {
			delete this.history[keys[i]];
		}
	}
	
	// remember scroll position (percentage)
	var maxScroll = this.$history.prop("scrollHeight") - this.$history.innerHeight(),
		scrollPos = maxScroll ? Math.ceil(this.$history.scrollTop() / maxScroll) : 1;
	console.log("scroll percentage: "+(scrollPos * 100)+"%");
	
	this.$history.html("");
	for (var x in this.history) {
		this.$history.append(
			$('&lt;div class="msg" />').append(
				$('&lt;span class="u' + (this.history[x].u ? '' : ' own') + '" />').text(this.history[x].u ? (main.server.names[this.history[x].u] ? main.server.names[this.history[x].u] : this.history[x].u) : "Me"),
				$('&lt;span class="t" />').text(this.history[x].t)
			)
		);
	}
	
	// scroll
	this.$history.scrollTop((this.$history.prop("scrollHeight") - this.$history.innerHeight()) * scrollPos);
};

main.miscs.chat = new Chat();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Board.html">Board</a></li><li><a href="Chat.html">Chat</a></li><li><a href="Cursor.html">Cursor</a></li><li><a href="Debug.html">Debug</a></li><li><a href="Draw.html">Draw</a></li><li><a href="History.html">History</a></li><li><a href="Main.html">Main</a></li><li><a href="Selection.html">Selection</a></li><li><a href="Server.html">Server</a></li><li><a href="Shape.html">Shape</a></li><li><a href="Table.html">Table</a></li><li><a href="Text.html">Text</a></li><li><a href="Tools.html">Tools</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BOARDMAXHEIGHT">BOARDMAXHEIGHT</a></li><li><a href="global.html#BOARDMAXWIDTH">BOARDMAXWIDTH</a></li><li><a href="global.html#BroadcastType">BroadcastType</a></li><li><a href="global.html#debug">debug</a></li><li><a href="global.html#hash">hash</a></li><li><a href="global.html#HistoryType">HistoryType</a></li><li><a href="global.html#lcfirst">lcfirst</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#MULTIPLIER">MULTIPLIER</a></li><li><a href="global.html#ToolSettingType">ToolSettingType</a></li><li><a href="global.html#ucfirst">ucfirst</a></li><li><a href="global.html#UNDOSTEPS">UNDOSTEPS</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Thu Sep 17 2015 23:52:33 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
